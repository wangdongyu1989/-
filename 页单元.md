# Memory-Management

硬件的分页单元
------------
分页单元(paging unit)把线性地址转换成物理地址。它把所请求的存取类型和线性地址的存取权限相比，如果这次内存存取是无效的，则产生一个页错误异常。

为了效率起见，线性地址被分成以固定长度为单位的组，称为页。页内连续的线性地址被映射到连续的物理地址中。用这种方式内核可以指定物理地址和页的存取权限，以代替它所包含的全部线性地址的存取权限。

把线性地址映射到物理地址的数据结构称为页表(page table)。页表存放在主存中，并在启动分页单元以前必须由内核对页表进行适当的初始化。

在intel处理器，通过设置cr0寄存器的PG标志启动分页。当PG=0时，线性地址被解释成物理地址。

![image](https://github.com/wangdongyu1989/Memory-Management/blob/master/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%8420170402a.jpg "分页单元")

32位的线性地址被分成3个域，10位：目录，10位：页表，12位：偏移量。

线性地址的转换分为两步完成，每一步都是基于一种转换表，第一种转换表称为页目录表(page directory)，第二种转换表称为页表(page table)。

使用这两种二级模式的目的在于减少每个进程页表所需RAM的数量。如果使用简单的一级页表，那将需要高达2的20次幂个表象（也就是，在每个4个字节时，需要4MB RAM）来表示每个进程的页表（如果进程使用全部4GB线性地址空间），即使一个进程不使用那个范围内的所有地址。二级模式通过只为进程实际使用的那些虚拟内存区请求页表来减少内存容量。

每个活动进程必须有一个分配给它的页目录。不过，没有必要马上为进程的所有页表都分配RAM。只有在进程实际需要一个页表时才给页表分配RAM会更为有效率。

页目录项和页表项有同样的结构，每项都包含下面的字段：
![image](https://github.com/wangdongyu1989/Memory-Management/blob/master/images/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84201700611a.jpg)

P--位0是存在（Present）标志，用于指明表项对地址转换是否有效。P=1表示有效；P=0表示无效。在页转换过程中，如果说涉及的页目录或页表的表项无效，则会导致一个异常。如果P=0，那么除表示表项无效外，其余位可供程序自由使用，如图4-18b所示。例如，操作系统可以使用这些位来保存已存储在磁盘上的页面的序号。

R/W--位1是读/写（Read/Write）标志。如果等于1，表示页面可以被读、写或执行。如果为0，表示页面只读或可执行。当处理器运行在超级用户特权级（级别0、1或2）时，则R/W位不起作用。页目录项中的R/W位对其所映射的所有页面起作用。

U/S--位2是用户/超级用户（User/Supervisor）标志。如果为1，那么运行在任何特权级上的程序都可以访问该页面。如果为0，那么页面只能被运行在超级用户特权级（0、1或2）上的程序访问。页目录项中的U/S位对其所映射的所有页面起作用。

A--位5是已访问（Accessed）标志。当处理器访问页表项映射的页面时，页表表项的这个标志就会被置为1。当处理器访问页目录表项映射的任何页面时，页目录表项的这个标志就会被置为1。处理器只负责设置该标志，操作系统可通过定期地复位该标志来统计页面的使用情况。

D--位6是页面已被修改（Dirty）标志。当处理器对一个页面执行写操作时，就会设置对应页表表项的D标志。处理器并不会修改页目录项中的D标志。

AVL--该字段保留专供程序使用。处理器不会修改这几位，以后的升级处理器也不会。

PAGE SIZE只用于页目录项，如果为1表示启用大页，2M或者4M

物理地址扩展(PAE)分页机制
----------------------

大型服务器需要大于4GB的RAM来同时运行数以千计的进程，近几年这对Intel造成了压力，所以必须扩展32位80x86结构支持的RAM容量。

Intel通过在它的处理器上把管脚从32增加到36已经满足了这些需求。从Pentium Pro开始，Intel所有处理器现在寻址能力达2的36次幂=64GB。不过，只有引入一种新的分页机制把32位线性地址转换为36位物理地址才能增加使用所增加的物理地址。
通过设置cr4控制寄存器中物理地址扩展(PAE)标志激活PAE。页目录项中的页大小标志PS启用大尺寸页。
Intel为了支持PAE已经改变了分页机制：
* 64G的RAM被分成2的24次幂个页框，页表项的物理地址字段从20位扩展到24位。因为PAE页表项必须包含12个标记位和24个物理地址，总数之和为36，页表项大小从32位变成64位增加了一倍。结果，一个4KB的页表包含512个表项而不是1024个表项。
* 引入一个叫做页目录指针表(PDPT)的页表新级别，它由4个64位表项组成。
* cr3控制寄存器包含一个27位的页目录指针表基地址字段。因为PDPT存放在RAM的前4GB中，并在32字节（2的5次幂）的倍数上对齐，因此27位足以表示这种表的基地址。
* 当把线性地址映射到4KB的页时，32位线性地址按一下方式解释
  *  cr3 指向一个PDPT
  *  31-30 指向PDPT中4个表项中一个
  *  29-21 指向页目录中512项的一个
  *  20-12 指向页表中512项的一个
  *  11-0 4KB页中的偏移量

![image](https://github.com/wangdongyu1989/Memory-Management/blob/master/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%8420170403a.png "PAE")
